name: Deploy Model to Endpoint

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Trigger an Azure Machine Learning job"]
    types:
      - completed

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'release' }}
    steps:
    - name: Check out repo
      uses: actions/checkout@main
      
    - name: Install az ml extension
      run: az extension add -n ml -y
      
    - name: Azure login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        
    - name: Create or update endpoint
      run: |
        az ml online-endpoint create --file deploy/endpoint.yml \
          --resource-group devoteam --workspace-name devoteam || true
          
    - name: Deploy model
      run: |
        az ml online-deployment create --file deploy/deployment.yml \
          --resource-group devoteam --workspace-name devoteam --all-traffic
